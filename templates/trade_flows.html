{% extends "layout.html" %}

{% block title %}Trade Flows - Zlatan Agriculture{% endblock %}

{% block content %}


<!-- header -->
<section class="hero-section">
  <h2>Global Trade Flows</h2>
  <p class="section-description">
    Track international agricultural trade between countries. See import/export patterns, commodities, and trade values.
  </p>
</section>

<!-- statistics -->
<section class="stats-container">
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Total Trade Records</h4>
      <div class="stat-number">{{ total_trades or 0 }}</div>
      <p class="stat-detail">Tracked transactions</p>
    </div>
    <div class="stat-card">
      <h4>Total Trade Value</h4>
      <div class="stat-number">${{ "{:,.0f}".format(total_value or 0) }}</div>
      <p class="stat-detail">Combined imports & exports</p>
    </div>
    <div class="stat-card">
      <h4>Active Countries</h4>
      <div class="stat-number">{{ active_countries or 0 }}</div>
      <p class="stat-detail">Trading partners</p>
    </div>
    <div class="stat-card">
      <h4>Commodities Traded</h4>
      <div class="stat-number">{{ traded_commodities or 0 }}</div>
      <p class="stat-detail">Different products</p>
    </div>
  </div>
</section>


<!-- add new trade flow button -->
<section class="filters-section" style="margin-bottom: 2rem;">
  <button onclick="openAddModal()" class="btn" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
    + Add New Trade Flow
  </button>
</section>

<!-- filter section -->
<section class="filters-section" style="margin-bottom: 2rem;">
  <h3>Filter Trade Flows</h3>
  <form method="GET" action="/trades" class="filters-form" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
    
    <div class="filter-group" style="flex: 1; min-width: 180px;">
      <label for="reporter_country" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Reporter Country</label>
      <select name="reporter_country" id="reporter_country" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">All Countries</option>
        {% for country in reporter_countries %}
        <option value="{{ country['country_code'] }}" {% if selected_reporter == country['country_code']|string %}selected{% endif %}>
          {{ country['country_name'] }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="filter-group" style="flex: 1; min-width: 180px;">
      <label for="partner_country" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Partner Country</label>
      <select name="partner_country" id="partner_country" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">All Partners</option>
        {% for country in partner_countries %}
        <option value="{{ country['country_code'] }}" {% if selected_partner == country['country_code']|string %}selected{% endif %}>
          {{ country['country_name'] }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="filter-group" style="flex: 1; min-width: 140px;">
      <label for="trade_type" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Trade Type</label>
      <select name="trade_type" id="trade_type" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">All Types</option>
        <option value="Export" {% if selected_trade_type == 'Export' %}selected{% endif %}>Export</option>
        <option value="Import" {% if selected_trade_type == 'Import' %}selected{% endif %}>Import</option>
      </select>
    </div>
    
    <div class="filter-group" style="flex: 1; min-width: 120px;">
      <label for="year" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Year</label>
      <select name="year" id="year" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">All Years</option>
        {% for year in available_years %}
        <option value="{{ year }}" {% if selected_year == year|string %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div class="filter-group" style="flex: 1; min-width: 180px;">
      <label for="commodity" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">Commodity</label>
      <select name="commodity" id="commodity" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">All Commodities</option>
        {% for commodity in available_commodities %}
        <option value="{{ commodity['fao_code'] }}" {% if selected_commodity == commodity['fao_code']|string %}selected{% endif %}>
          {{ commodity['commodity_name'] }}
        </option>
        {% endfor %}
      </select>
    </div>
    
    <div class="filter-actions" style="display: flex; gap: 0.5rem;">
      <button type="submit" class="btn" style="padding: 0.5rem 1.5rem;">Apply Filters</button>
      <a href="/trades" class="btn btn-secondary" style="padding: 0.5rem 1rem; text-decoration: none;">Reset</a>
    </div>
  </form>
</section>

<!-- trade table -->
<section class="trade-section">
  <h3>Trade Flow Records</h3>
  <p class="section-description">
    Detailed trade transactions between countries
    {% if selected_reporter or selected_partner or selected_trade_type or selected_year or selected_commodity %}
    (Filtered results)
    {% endif %}
  </p>
  
  {% if trade_flows %}
  <table class="data-table">
    <thead>
      <tr>
        <th>Year</th>
        <th>Reporter Country</th>
        <th>Trade Type</th>
        <th>Partner Country</th>
        <th>Commodity</th>
        <th>Value</th>
        <th>Unit</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for trade in trade_flows %}
      <tr>
        <td><strong>{{ trade['year'] }}</strong></td>
        <td>
          <a href="/countries/{{ trade['reporter_country'] }}" style="text-decoration: none; color: #2c3e50;">
            {{ trade['reporter_name'] or 'Unknown' }}
          </a>
        </td>
        <td>
          <span class="{% if trade['trade_type'] == 'Export' %}positive{% elif trade['trade_type'] == 'Import' %}negative{% endif %}">
            {{ trade['trade_type'] or 'N/A' }}
          </span>
        </td>
        <td>
          <a href="/countries/{{ trade['partner_country'] }}" style="text-decoration: none; color: #2c3e50;">
            {{ trade['partner_name'] or 'Unknown' }}
          </a>
        </td>
        <td>
          <a href="/commodities/{{ trade['trade_item'] }}" style="text-decoration: none; color: #2c3e50;">
            {{ trade['commodity_name'] or 'Unknown' }}
          </a>
        </td>
        <td>
          <strong>
            {% if trade['unit'] and ('$' in trade['unit'] or 'USD' in trade['unit']) %}
              ${{ "{:,}".format(trade['value'] or 0) }}
            {% else %}
              {{ "{:,}".format(trade['value'] or 0) }}
            {% endif %}
          </strong>
        </td>
        <td>{{ trade['unit'] or 'N/A' }}</td>
        <td>
          <button onclick="openEditModal({{ trade['unique_id'] }}, '{{ trade['reporter_country'] }}', '{{ trade['partner_country'] }}', '{{ trade['trade_item'] }}', '{{ trade['trade_type'] }}', {{ trade['year'] }}, {{ trade['value'] }}, '{{ trade['unit'] }}')"
                  class="btn-action btn-edit" title="Edit">
            Edit
          </button>
          <button onclick="openDeleteModal({{ trade['unique_id'] }})"
                  class="btn-action btn-delete" title="Delete">
            Delete
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
  {% if total_trades > trade_flows|length %}
  <div style="text-align: center; margin-top: 1rem; color: #7f8c8d;">
    Showing {{ trade_flows|length }} of {{ total_trades }} trade records
  </div>
  {% endif %}
  
  {% else %}
  <div class="no-data">
    <p>No trade flows found matching your criteria.</p>
    <p style="margin-top: 0.5rem;">Try adjusting your filters or <a href="/trades">reset all filters</a>.</p>
  </div>
  {% endif %}
</section>

<!-- trade distribution -->
{% if trade_type_breakdown %}
<section class="trade-balance-section">
  <h3>Trade Type Distribution</h3>
  <p class="section-description">
    Breakdown of trade flows by transaction type
  </p>
  
  <div class="feature-grid">
    {% for trade_type, stats in trade_type_breakdown.items() %}
    <div class="feature-card">
      <h4>{{ trade_type }}</h4>
      <div class="info-list">
        <dt>Total Transactions</dt>
        <dd><strong>{{ "{:,}".format(stats['count'] or 0) }}</strong></dd>
        
        <dt>Total Value</dt>
        <dd>${{ "{:,.0f}".format(stats['total_value'] or 0) }}</dd>
        
        <dt>Average Value</dt>
        <dd>${{ "{:,.0f}".format(stats['avg_value'] or 0) }}</dd>
        
        <dt>Share of Total</dt>
        <dd>{{ "%.1f"|format(stats['percentage'] or 0) }}%</dd>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- top partners -->
{% if top_partners %}
<section class="partnerships-section">
  <h3>Top Trading Partners</h3>
  <p class="section-description">
    Countries with the highest trade volumes
  </p>
  
  <table class="data-table">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Country Pair</th>
        <th>Total Transactions</th>
        <th>Total Trade Value</th>
        <th>Main Commodity</th>
      </tr>
    </thead>
    <tbody>
      {% for partner in top_partners %}
      <tr>
        <td><strong>#{{ loop.index }}</strong></td>
        <td>{{ partner['reporter_name'] }} â†” {{ partner['partner_name'] }}</td>
        <td>{{ "{:,}".format(partner['transaction_count'] or 0) }}</td>
        <td><strong>${{ "{:,}".format(partner['total_value'] or 0) }}</strong></td>
        <td>{{ partner['top_commodity'] or 'Various' }}</td>
        <td>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<!-- top comodities by volume -->
{% if top_commodities_traded %}
<section class="commodities-section">
  <h3>Most Traded Commodities</h3>
  <p class="section-description">
    Agricultural products with highest trade volumes
  </p>
  
  <div class="feature-grid">
    {% for commodity in top_commodities_traded %}
    <div class="feature-card">
      <h4>{{ commodity['commodity_name'] }}</h4>
      <div class="info-list">
        <dt>Trade Transactions</dt>
        <dd><strong>{{ "{:,}".format(commodity['trade_count'] or 0) }}</strong></dd>
        
        <dt>Total Value</dt>
        <dd>${{ "{:,.0f}".format(commodity['total_value'] or 0) }}</dd>
        
        <dt>Countries Involved</dt>
        <dd>{{ commodity['country_count'] or 0 }} countries</dd>
        
        <dt>Average Price</dt>
        <dd>${{ "{:,.2f}".format(commodity['avg_value'] or 0) }}</dd>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- Add Trade Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Trade Flow Record</h3>
      <span class="close" onclick="closeAddModal()">&times;</span>
    </div>
    <form method="POST" action="/trades/add" class="modal-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="add_reporter">Reporter Country *</label>
          <select name="reporter_country" id="add_reporter" required>
            <option value="">Select Country</option>
            {% for country in reporter_countries %}
            <option value="{{ country['country_code'] }}">{{ country['country_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="add_partner">Partner Country *</label>
          <select name="partner_country" id="add_partner" required>
            <option value="">Select Partner</option>
            {% for country in partner_countries %}
            <option value="{{ country['country_code'] }}">{{ country['country_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="add_commodity">Commodity *</label>
          <select name="commodity" id="add_commodity" required>
            <option value="">Select Commodity</option>
            {% for commodity in available_commodities %}
            <option value="{{ commodity['fao_code'] }}">{{ commodity['commodity_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="add_trade_type">Trade Type *</label>
          <select name="trade_type" id="add_trade_type" required>
            <option value="">Select Type</option>
            {% for trade_type in available_trade_types %}
            <option value="{{ trade_type }}">{{ trade_type }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="add_year">Year *</label>
          <input type="number" name="year" id="add_year" required min="1900" max="2100" placeholder="2024">
        </div>

        <div class="form-group">
          <label for="add_value">Value *</label>
          <input type="number" name="value" id="add_value" required step="0.01" min="0" placeholder="1000.00">
        </div>

        <div class="form-group">
          <label for="add_unit">Unit *</label>
          <select name="unit" id="add_unit" required>
            <option value="">Select Unit</option>
            {% for unit in available_units %}
            <option value="{{ unit }}">{{ unit }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" onclick="closeAddModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn">Add Trade Flow</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Trade Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Trade Flow Record</h3>
      <span class="close" onclick="closeEditModal()">&times;</span>
    </div>
    <form method="POST" id="editForm" class="modal-form">
      <input type="hidden" name="trade_id" id="edit_trade_id">

      <div class="form-grid">
        <div class="form-group">
          <label for="edit_reporter">Reporter Country *</label>
          <select name="reporter_country" id="edit_reporter" required>
            <option value="">Select Country</option>
            {% for country in reporter_countries %}
            <option value="{{ country['country_code'] }}">{{ country['country_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="edit_partner">Partner Country *</label>
          <select name="partner_country" id="edit_partner" required>
            <option value="">Select Partner</option>
            {% for country in partner_countries %}
            <option value="{{ country['country_code'] }}">{{ country['country_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="edit_commodity">Commodity *</label>
          <select name="commodity" id="edit_commodity" required>
            <option value="">Select Commodity</option>
            {% for commodity in available_commodities %}
            <option value="{{ commodity['fao_code'] }}">{{ commodity['commodity_name'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="edit_trade_type">Trade Type *</label>
          <select name="trade_type" id="edit_trade_type" required>
            <option value="">Select Type</option>
            {% for trade_type in available_trade_types %}
            <option value="{{ trade_type }}">{{ trade_type }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="edit_year">Year *</label>
          <input type="number" name="year" id="edit_year" required min="1900" max="2100">
        </div>

        <div class="form-group">
          <label for="edit_value">Value *</label>
          <input type="number" name="value" id="edit_value" required step="0.01" min="0">
        </div>

        <div class="form-group">
          <label for="edit_unit">Unit *</label>
          <select name="unit" id="edit_unit" required>
            <option value="">Select Unit</option>
            {% for unit in available_units %}
            <option value="{{ unit }}">{{ unit }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn">Update Trade Flow</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3>Confirm Deletion</h3>
      <span class="close" onclick="closeDeleteModal()">&times;</span>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this trade flow record?</p>
      <p style="color: #e74c3c; margin-top: 1rem;">This action cannot be undone.</p>
    </div>
    <form method="POST" id="deleteForm">
      <input type="hidden" name="trade_id" id="delete_trade_id">
      <div class="modal-footer">
        <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn" style="background-color: #e74c3c;">Delete</button>
      </div>
    </form>
  </div>
</div>

<style>
/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  max-width: 900px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  animation: slideDown 0.3s;
}

@keyframes slideDown {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  padding: 1.5rem 2rem;
  background-color: #2c3e50;
  color: white;
  border-radius: 8px 8px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.5rem;
}

.close {
  color: white;
  font-size: 2rem;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s;
}

.close:hover {
  color: #e74c3c;
}

.modal-form {
  padding: 2rem;
}

.modal-body {
  padding: 2rem;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #2c3e50;
}

.form-group input,
.form-group select {
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #27ae60;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #eee;
}

/* Action Buttons */
.btn-action {
  padding: 0.4rem 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
  font-weight: 600;
  transition: all 0.3s;
  margin: 0 0.25rem;
}

.btn-edit {
  background-color: #3498db;
  color: white;
}

.btn-edit:hover {
  background-color: #2980b9;
}

.btn-delete {
  background-color: #e74c3c;
  color: white;
}

.btn-delete:hover {
  background-color: #c0392b;
}

.btn-secondary {
  background-color: #95a5a6;
  color: white;
}

.btn-secondary:hover {
  background-color: #7f8c8d;
}
</style>

<script>
// Add Modal Functions
function openAddModal() {
  document.getElementById('addModal').style.display = 'block';
}

function closeAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

// Edit Modal Functions
function openEditModal(id, reporter, partner, commodity, tradeType, year, value, unit) {
  document.getElementById('edit_trade_id').value = id;
  document.getElementById('edit_reporter').value = reporter;
  document.getElementById('edit_partner').value = partner;
  document.getElementById('edit_commodity').value = commodity;
  document.getElementById('edit_trade_type').value = tradeType;
  document.getElementById('edit_year').value = year;
  document.getElementById('edit_value').value = value;
  document.getElementById('edit_unit').value = unit;

  document.getElementById('editForm').action = '/trades/edit/' + id;
  document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// Delete Modal Functions
function openDeleteModal(id) {
  document.getElementById('delete_trade_id').value = id;
  document.getElementById('deleteForm').action = '/trades/delete/' + id;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const addModal = document.getElementById('addModal');
  const editModal = document.getElementById('editModal');
  const deleteModal = document.getElementById('deleteModal');

  if (event.target == addModal) {
    closeAddModal();
  } else if (event.target == editModal) {
    closeEditModal();
  } else if (event.target == deleteModal) {
    closeDeleteModal();
  }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeAddModal();
    closeEditModal();
    closeDeleteModal();
  }
});
</script>

{% endblock %}