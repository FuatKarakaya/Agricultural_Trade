{% extends "layout.html" %}

{% block title %}Trade Flows Statistics - Zlatan Agriculture{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Hero Section -->
<section class="hero-section">
  <h2>Trade Flows Statistics & Analytics</h2>
  <p class="section-description">
    Comprehensive visual analytics of global agricultural trade patterns, trends, and distributions.
  </p>
</section>

<!-- Statistics Cards -->
<section class="stats-container">
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Total Trade Value</h4>
      <div class="stat-number">${{ "{:,.0f}".format(total_value or 0) }}</div>
      <p class="stat-detail">Combined imports & exports</p>
    </div>
    <div class="stat-card">
      <h4>Total Trade Records</h4>
      <div class="stat-number">{{ "{:,}".format(total_trades or 0) }}</div>
      <p class="stat-detail">Recorded transactions</p>
    </div>
    <div class="stat-card">
      <h4>Trading Countries</h4>
      <div class="stat-number">{{ total_countries or 0 }}</div>
      <p class="stat-detail">Active participants</p>
    </div>
    <div class="stat-card">
      <h4>Years Covered</h4>
      <div class="stat-number">{{ year_range or 'N/A' }}</div>
      <p class="stat-detail">Historical data range</p>
    </div>
  </div>
</section>

<!-- trade distribution -->
{% if trade_type_breakdown %}
<section class="trade-balance-section">
  <h3>Trade Type Distribution</h3>
  <p class="section-description">
    Breakdown of trade flows by transaction type
  </p>

  <div class="feature-grid">
    {% for trade_type, stats in trade_type_breakdown.items() %}
    <div class="feature-card">
      <h4>{{ trade_type }}</h4>
      <div class="info-list">
        <dt>Total Transactions</dt>
        <dd><strong>{{ "{:,}".format(stats['count'] or 0) }}</strong></dd>

        <dt>Total Value</dt>
        <dd>${{ "{:,.0f}".format(stats['total_value'] or 0) }}</dd>

        <dt>Average Value</dt>
        <dd>${{ "{:,.0f}".format(stats['avg_value'] or 0) }}</dd>

        <dt>Share of Total</dt>
        <dd>{{ "%.1f"|format(stats['percentage'] or 0) }}%</dd>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- top partners -->
{% if top_partners %}
<section class="partnerships-section">
  <h3>Top Trading Partners</h3>
  <p class="section-description">
    Countries with the highest trade volumes
  </p>

  <table class="data-table">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Country Pair</th>
        <th>Total Transactions</th>
        <th>Total Trade Value</th>
        <th>Main Commodity</th>
      </tr>
    </thead>
    <tbody>
      {% for partner in top_partners %}
      <tr>
        <td><strong>#{{ loop.index }}</strong></td>
        <td>{{ partner['reporter_name'] }} ↔ {{ partner['partner_name'] }}</td>
        <td>{{ "{:,}".format(partner['transaction_count'] or 0) }}</td>
        <td><strong>${{ "{:,.0f}".format(partner['total_value'] or 0) }}</strong></td>
        <td>{{ partner['top_commodity'] or 'Various' }}</td>
        <td>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

<!-- top comodities by volume -->
{% if top_commodities_traded %}
<section class="commodities-section">
  <h3>Most Traded Commodities</h3>
  <p class="section-description">
    Agricultural products with highest trade volumes
  </p>

  <div class="feature-grid">
    {% for commodity in top_commodities_traded %}
    <div class="feature-card">
      <h4>{{ commodity['commodity_name'] }}</h4>
      <div class="info-list">
        <dt>Trade Transactions</dt>
        <dd><strong>{{ "{:,}".format(commodity['trade_count'] or 0) }}</strong></dd>

        <dt>Total Value</dt>
        <dd>${{ "{:,.0f}".format(commodity['total_value'] or 0) }}</dd>

        <dt>Countries Involved</dt>
        <dd>{{ commodity['country_count'] or 0 }} countries</dd>

        <dt>Average Price</dt>
        <dd>${{ "{:,.2f}".format(commodity['avg_value'] or 0) }}</dd>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}


<!-- Chart Section 1: Time Series - Exports vs Imports -->
<section class="stats-container">
  <h3>Exports vs Imports Over Time</h3>
  <p class="section-description">Historical trends comparing export and import values by year</p>
  <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
    <canvas id="exportsImportsChart" data-chart='{{ time_series_data | tojson }}'></canvas>
  </div>
</section>

<!-- Chart Section 2: Top Countries and Trade Balance -->
<section class="stats-container">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
    <div>
      <h3>Top Trading Countries</h3>
      <p class="section-description">Top 10 countries by total trade value</p>
      <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
        <canvas id="topCountriesChart" data-chart='{{ top_countries_data | tojson }}'></canvas>
      </div>
    </div>
    <div>
      <h3>Trade Balance by Country</h3>
      <p class="section-description">Net exports vs imports for top countries</p>
      <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
        <canvas id="tradeBalanceChart" data-chart='{{ trade_balance_data | tojson }}'></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Chart Section 3: Commodities and Regional Distribution -->
<section class="stats-container">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
    <div>
      <h3>Top Commodities Traded</h3>
      <p class="section-description">Product mix in agricultural trade</p>
      <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
        <canvas id="commoditiesChart" data-chart='{{ commodities_data | tojson }}'></canvas>
      </div>
    </div>
    <div>
      <h3>Regional Trade Distribution</h3>
      <p class="section-description">Trade value by geographic region</p>
      <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
        <canvas id="regionalChart" data-chart='{{ regional_data | tojson }}'></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Chart Section 4: Trade Volume Over Time -->
<section class="stats-container">
  <h3>Trade Volume Over Time</h3>
  <p class="section-description">Overall growth in trade activity by year</p>
  <div class="chart-wrapper" style="position: relative; height: 400px; margin-top: 1rem;">
    <canvas id="volumeChart" data-chart='{{ volume_data | tojson }}'></canvas>
  </div>
</section>

<!-- Back Link -->
<section class="stats-container" style="text-align: center; margin-top: 2rem;">
  <a href="/trades" class="btn">← Back to Trade Data</a>
</section>

<script src="{{ url_for('static', filename='js/trade_statistics.js') }}"></script>

<style>
/* Responsive Chart Layout */
@media (max-width: 768px) {
  section div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
}

.chart-wrapper {
  background: white;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
</style>

{% endblock %}
