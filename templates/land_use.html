{% extends "layout.html" %}

{% block title %}Land Use {{ year }} - Zlatan Agriculture{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/land_use.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* Sıralanabilir başlıklar için stil */
.sortable-header {
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 20px !important;
}

.sortable-header:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
  position: absolute;
  right: 5px;
  font-size: 0.8em;
  opacity: 0.5;
}

.sort-icon.active {
  opacity: 1;
  font-weight: bold;
}
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Hero Section -->
<section class="hero-section">
  <h2>Land Use Summary – {{ year }}</h2>
  <p>
    Aggregated land use values by country. Select a year between 1961 and 2023 to explore historical data.
  </p>
</section>

<!-- Stats Section with Pie Chart -->
<section class="stats-container">
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Total Countries</h4>
      <div class="stat-number">{{ total_countries or 0 }}</div>
      <p class="stat-detail">Countries with land use data in {{ year }}</p>
    </div>

    <div class="stat-card">
      <h4>
        {% if not selected_country_id %}
        Global Land Distribution
        {% else %}
        Land Distribution
        {% endif %}
      </h4>
      <div class="chart-container">
        <canvas id="landUseChart" 
                data-pie-chart='{{ pie_chart_data | tojson }}'></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Land Use Table -->
<!-- Land Use Table -->
<section class="producers-section">
  <h3>Land Use Data ({{ year }})</h3>

  <div class="year-filter-bar">
    <form method="get" action="{{ url_for('landuse.landUsePage') }}" class="filter-form">
      <label for="year-select">Year:</label>
      <select id="year-select" name="year" onchange="this.form.submit()">
        {% for y in years %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <label for="country-select">Country:</label>
      <select id="country-select" name="country_id" onchange="this.form.submit()">
        <option value="" {% if not selected_country_id %}selected{% endif %}>All countries</option>
        {% for c in countries %}
          <option value="{{ c['country_id'] }}"
                  {% if selected_country_id == c['country_id'] %}selected{% endif %}>
            {{ c['country_name'] }}
          </option>
        {% endfor %}
      </select>
    </form>

    <!-- ADD RECORD BUTONU - Sadece Admin Görebilir -->
    {% if is_admin %}
    <a href="{{ url_for('landuse.add_land_use_form', year=year, country_id=selected_country_id) }}"
       class="btn-add-country">
      Add Record
    </a>
    {% endif %}
    <a href="{{ url_for('landuse.country_timeline', country_id=selected_country_id) }}"
       class="btn-add-country">
      Timeline View
    </a>
  </div>

  {% if records %}
  <!-- Yeni eklenen wrapper div -->
  <div class="table-wrapper">
    <table class="data-table">
      <thead>
        <tr>
          <!-- Makro: Sıralanabilir başlık oluştur -->
          {% macro sortable_th(column, display_name) %}
            {% if sort_by == column %}
              {# Bu sütuna göre sıralama aktif #}
              {% if order == 'desc' %}
                {# Şu an descending → Bir sonraki tıklamada ascending #}
                <th class="sortable-header" 
                    onclick="window.location.href='{{ url_for('landuse.landUsePage', 
                      year=year, 
                      country_id=selected_country_id, 
                      sort=column, 
                      order='asc') }}'">
                  {{ display_name }}
                  <span class="sort-icon active">▼</span>
                </th>
              {% else %}
                {# Şu an ascending → Bir sonraki tıklamada varsayılana dön #}
                <th class="sortable-header" 
                    onclick="window.location.href='{{ url_for('landuse.landUsePage', 
                      year=year, 
                      country_id=selected_country_id) }}'">
                  {{ display_name }}
                  <span class="sort-icon active">▲</span>
                </th>
              {% endif %}
            {% else %}
              {# Bu sütuna göre sıralama aktif değil → İlk tıklamada descending #}
              <th class="sortable-header" 
                  onclick="window.location.href='{{ url_for('landuse.landUsePage', 
                    year=year, 
                    country_id=selected_country_id, 
                    sort=column, 
                    order='desc') }}'">
                {{ display_name }}
                <span class="sort-icon">⬍</span>
              </th>
            {% endif %}
          {% endmacro %}

          {{ sortable_th('country_name', 'Country') }}
          <th>Year</th>
          <th>Unit</th>
          {{ sortable_th('country_area', 'Country area') }}
          {{ sortable_th('land_area', 'Land area') }}
          {{ sortable_th('inland_waters', 'Inland waters') }}
          {{ sortable_th('arable_land', 'Arable land') }}
          {{ sortable_th('permanent_crops', 'Permanent crops') }}
          {{ sortable_th('permanent_meadows_and_pastures', 'Permanent meadows and pastures') }}
          {{ sortable_th('forest_land', 'Forest land') }}
          {{ sortable_th('other_land', 'Other land') }}
          
          <!-- ACTIONS SÜTUNU - Sadece Admin Görebilir -->
          {% if is_admin %}
          <th>Actions</th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for row in records %}
        <tr>
          <td>
            {% if row['country_id'] %}
              <a href="/countries/{{ row['country_id'] }}" class="country-link">
                <strong>{{ row['country_name'] }}</strong>
              </a>
            {% else %}
              <strong>{{ row['country_name'] }}</strong>
            {% endif %}
          </td>

          <td>{{ row['year'] }}</td>
          <td>{{ row['unit'] }}</td>

          <td>
            {% if row['country_area'] is not none %}
              {{ "{:,}".format(row['country_area']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['land_area'] is not none %}
              {{ "{:,}".format(row['land_area']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['inland_waters'] is not none %}
              {{ "{:,}".format(row['inland_waters']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['arable_land'] is not none %}
              {{ "{:,}".format(row['arable_land']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['permanent_crops'] is not none %}
              {{ "{:,}".format(row['permanent_crops']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['permanent_meadows_and_pastures'] is not none %}
              {{ "{:,}".format(row['permanent_meadows_and_pastures']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['forest_land'] is not none %}
              {{ "{:,}".format(row['forest_land']) }}
            {% else %}N/A{% endif %}
          </td>

          <td>
            {% if row['other_land'] is not none %}
              {{ "{:,.2f}".format(row['other_land']) }}
            {% else %}N/A{% endif %}
          </td>

          <!-- UPDATE VE DELETE BUTONLARI - Sadece Admin Görebilir -->
          {% if is_admin %}
          <td>
            <a href="{{ url_for('landuse.edit_land_use_form',
                        country_id=row['country_id'],
                        year=row['year']) }}"
                      class="btn-update">
                      Update
            </a>

            <form method="post"
                  action="{{ url_for('landuse.delete_land_use') }}"
                  style="display: inline;"
                  onsubmit="return confirm('Bu ülke ve yıl için tüm girdiler silinsin mi?');">
              <input type="hidden" name="country_id" value="{{ row['country_id'] }}">
              <input type="hidden" name="year" value="{{ row['year'] }}">
              <input type="hidden" name="redirect_country_id" value="{{ selected_country_id or '' }}">
              <button type="submit" class="btn-delete">Delete</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- Wrapper div sonu -->

  {% else %}
  <div class="no-data">
    <p>No land use records found for {{ year }}.</p>
  </div>
  {% endif %}
</section>

<script src="{{ url_for('static', filename='js/land_use.js') }}"></script>

{% endblock %}