{% extends "layout.html" %}

{% block title %}Land Use {{ year }} - Zlatan Agriculture{% endblock %}

{% block content %}
<style>
  .country-link,
  .country-link:visited,
  .country-link:hover,
  .country-link:active {
    text-decoration: none;
    color: blue;
  }
  .flash-container {
    margin: 0.5rem 0 1rem 0;
  }

  .flash-message {
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }

  .flash-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .flash-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* Yıl + ülke filtresi barı (tablonun hemen üstü, solda) */
  .year-filter-bar {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    margin: 1rem 0;
    /* form ile Add Country butonu arasında biraz boşluk */
    gap: 12px;
  }

  .filter-form {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    border: 1px solid #ddd;
    background-color: #f7f7f7;
    flex-wrap: wrap;
  }

  .filter-form label {
    font-weight: 600;
    font-size: 0.9rem;
  }

  #year-select,
  #country-select {
    padding: 0.25rem 0.5rem;
    font-size: 0.9rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    cursor: pointer;
  }

  #year-select:focus,
  #country-select:focus {
    outline: none;
    border-color: #888;
  }

  /* Add Country butonu */
  .btn-add-country {
    display: inline-block;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    border: none;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-add-country:hover {
    opacity: 0.9;
  }

  /* Delete butonu */
  .btn-delete {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    border: none;
    background-color: #dc3545;
    color: #fff;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .btn-delete:hover {
    opacity: 0.9;
  }
  .btn-update {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    border: none;
    background-color: #17a2b8;
    color: #fff;
    font-size: 0.8rem;
    cursor: pointer;
    text-decoration: none;
    margin-right: 4px;
  }

  .btn-update:hover {
    opacity: 0.9;
  }

  .btn-delete {
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    border: none;
    background-color: #dc3545;
    color: #fff;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .btn-delete:hover {
    opacity: 0.9;
  }
</style>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<!-- Hero Section -->
<section class="hero-section">
  <h2>Land Use Summary – {{ year }}</h2>
  <p>
    Aggregated land use values by country. Select a year between 1961 and 2023 to explore historical data.
  </p>
</section>

<!-- Stats Section -->
<section class="stats-container">
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Total Countries</h4>
      <div class="stat-number">{{ total_countries or 0 }}</div>
      <p class="stat-detail">Countries with land use data in {{ year }}</p>
    </div>
    <div class="stat-card">
      <h4>Agricultural Land Share</h4>
      {% if agri_share is not none %}
        <div class="stat-number">
          {{ "%.2f"|format(agri_share) }}%
        </div>
        <p class="stat-detail">
          Share of land area used for agriculture
          {% if not selected_country_id %}
            (worldwide)
          {% else %}
            (selected country)
          {% endif %}
          in {{ year }}
        </p>
      {% else %}
        <div class="stat-number">N/A</div>
        <p class="stat-detail">Not enough data to compute ratio</p>
      {% endif %}
    </div>
  </div>
</section>

<!-- Land Use Table -->
<section class="producers-section">
  <h3>Land Use Data ({{ year }})</h3>
  <p class="section-description">
    Country area, land area, inland waters, arable land, permanent crops, permanent meadows and pastures,
    forest land, and calculated <strong>Other land</strong> for each country.
  </p>

  <!-- Yıl + ülke seçimi: tam tablonun üstünde solda, yanına Add Country -->
  <div class="year-filter-bar">
    <form method="get" action="{{ url_for('landuse.landUsePage') }}" class="filter-form">
      <!-- Year -->
      <label for="year-select">
        Year:
      </label>
      <select id="year-select" name="year" onchange="this.form.submit()">
        {% for y in years %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <!-- Country -->
      <label for="country-select">
        Country:
      </label>
      <select id="country-select" name="country_id" onchange="this.form.submit()">
        <option value="" {% if not selected_country_id %}selected{% endif %}>All countries</option>
        {% for c in countries %}
          <option value="{{ c['country_id'] }}"
                  {% if selected_country_id == c['country_id'] %}selected{% endif %}>
            {{ c['country_name'] }}
          </option>
        {% endfor %}
      </select>
    </form>

    <!-- Add Country butonu -->
    <a href="{{ url_for('landuse.add_land_use_form', year=year, country_id=selected_country_id) }}"
       class="btn-add-country">
      Add Record
    </a>
  </div>

  {% if records %}
  <table class="data-table">
    <thead>
      <tr>
        <th>Country</th>
        <th>Year</th>
        <th>Unit</th>
        <th>Country area</th>
        <th>Land area</th>
        <th>Inland waters</th>
        <th>Arable land</th>
        <th>Permanent crops</th>
        <th>Permanent meadows and pastures</th>
        <th>Forest land</th>
        <th>Other land</th>
        <th>Actions</th>  <!-- yeni kolon -->
      </tr>
    </thead>

    <tbody>
      {% for row in records %}
      <tr>
        <td>
          {% if row['country_id'] %}
            <a href="/countries/{{ row['country_id'] }}" class="country-link">
              <strong>{{ row['country_name'] }}</strong>
            </a>
          {% else %}
            <strong>{{ row['country_name'] }}</strong>
          {% endif %}
        </td>

        <td>{{ row['year'] }}</td>
        <td>{{ row['unit'] }}</td>

        <td>
          {% if row['country_area'] is not none %}
            {{ "{:,}".format(row['country_area']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['land_area'] is not none %}
            {{ "{:,}".format(row['land_area']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['inland_waters'] is not none %}
            {{ "{:,}".format(row['inland_waters']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['arable_land'] is not none %}
            {{ "{:,}".format(row['arable_land']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['permanent_crops'] is not none %}
            {{ "{:,}".format(row['permanent_crops']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['permanent_meadows_and_pastures'] is not none %}
            {{ "{:,}".format(row['permanent_meadows_and_pastures']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['forest_land'] is not none %}
            {{ "{:,}".format(row['forest_land']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['other_land'] is not none %}
            {{ "{:,.2f}".format(row['other_land']) }}
          {% else %}N/A{% endif %}
        </td>

        <!-- Delete butonu -->
        <td>
          <a href="{{ url_for('landuse.edit_land_use_form',
                      country_id=row['country_id'],
                      year=row['year']) }}"
                    class="btn-update">
                    Update
          </a>

          <form method="post"
                action="{{ url_for('landuse.delete_land_use') }}"
                onsubmit="return confirm('Bu ülke ve yıl için tüm girdiler silinsin mi?');">
            <input type="hidden" name="country_id" value="{{ row['country_id'] }}">
            <input type="hidden" name="year" value="{{ row['year'] }}">
            <!-- mevcut filtreyi korumak için -->
            <input type="hidden" name="redirect_country_id" value="{{ selected_country_id or '' }}">
            <button type="submit" class="btn-delete">
              Delete
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% else %}
  <div class="no-data">
    <p>No land use records found for {{ year }}.</p>
  </div>
  {% endif %}
</section>

{% endblock %}
