{% extends "layout.html" %}

{% block title %}Investments Timeline - {{ country_name or 'Select Country' }} - Zlatan Agriculture{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/investments.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* Sıralanabilir başlıklar için stil */
.sortable-header {
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 20px !important;
}

.sortable-header:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
  position: absolute;
  right: 5px;
  font-size: 0.8em;
  opacity: 0.5;
}

.sort-icon.active {
  opacity: 1;
  font-weight: bold;
}

.timeline-chart-container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.timeline-chart-container canvas {
  max-height: 350px;
}

.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

@media (max-width: 1200px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
}
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Hero Section -->
<section class="hero-section">
  <h2>Government Investments Timeline {% if country_name %}– {{ country_name }}{% endif %}</h2>
  <p>
    View historical government investment data for a specific country from 1961 to 2025.
  </p>
</section>

<!-- Country Selection -->
<section class="producers-section">
  <h3>Select Country</h3>

  <div class="year-filter-bar">
    <form method="get" action="{{ url_for('investments.country_timeline') }}" class="filter-form">
      <label for="country-select">Country:</label>
      <select id="country-select" name="country_id" onchange="this.form.submit()" required>
        <option value="">-- Select a country --</option>
        {% for c in countries %}
          <option value="{{ c['country_id'] }}"
                  {% if selected_country_id == c['country_id'] %}selected{% endif %}>
            {{ c['country_name'] }}
          </option>
        {% endfor %}
      </select>
    </form>

    {% if country_name %}
    <a href="{{ url_for('investments.investmentsPage') }}" class="btn-add-country">
      ← Back to All Countries
    </a>
    {% endif %}
  </div>

  {% if country_name and records %}
  
  <!-- Stats Card -->
  <div class="stats-container" style="margin-top: 20px;">
    <div class="stats-grid">
      <div class="stat-card">
        <h4>Country</h4>
        <div class="stat-number" style="font-size: 1.5em;">{{ country_name }}</div>
        <p class="stat-detail">Historical investment data</p>
      </div>
      
      <div class="stat-card">
        <h4>Years Available</h4>
        <div class="stat-number">{{ total_years }}</div>
        <p class="stat-detail">Records from {{ records|map(attribute='year')|min }} to {{ records|map(attribute='year')|max }}</p>
      </div>
    </div>
  </div>

  <!-- Timeline Charts - Two Separate Graphs -->
  <div class="charts-grid">
    <!-- Total Expenditure Chart -->
    <div class="timeline-chart-container">
      <h4 style="text-align: center; color: #333; margin-bottom: 20px;">Total Government Expenditure (2001-2023)</h4>
      <canvas id="totalExpenditureChart"></canvas>
    </div>

    <!-- Percentage Chart -->
    <div class="timeline-chart-container">
      <h4 style="text-align: center; color: #333; margin-bottom: 20px;">Sectoral Expenditure Share (2001-2023)</h4>
      <canvas id="percentageChart"></canvas>
    </div>
  </div>

  <!-- Data Table -->
  <h3 style="margin-top: 40px;">Historical Data Table</h3>
  
  <table class="data-table">
    <thead>
      <tr>
        <!-- Makro: Sıralanabilir başlık oluştur -->
        {% macro sortable_th(column, display_name) %}
          {% if sort_by == column %}
            {# Bu sütuna göre sıralama aktif #}
            {% if order == 'desc' %}
              {# Şu an descending → Bir sonraki tıklamada ascending #}
              <th class="sortable-header" 
                  onclick="window.location.href='{{ url_for('investments.country_timeline', 
                    country_id=selected_country_id, 
                    sort=column, 
                    order='asc') }}'">
                {{ display_name }}
                <span class="sort-icon active">▼</span>
              </th>
            {% else %}
              {# Şu an ascending → Bir sonraki tıklamada varsayılana dön #}
              <th class="sortable-header" 
                  onclick="window.location.href='{{ url_for('investments.country_timeline', 
                    country_id=selected_country_id) }}'">
                {{ display_name }}
                <span class="sort-icon active">▲</span>
              </th>
            {% endif %}
          {% else %}
            {# Bu sütuna göre sıralama aktif değil → İlk tıklamada descending #}
            <th class="sortable-header" 
                onclick="window.location.href='{{ url_for('investments.country_timeline', 
                  country_id=selected_country_id, 
                  sort=column, 
                  order='desc') }}'">
              {{ display_name }}
              <span class="sort-icon">⬍</span>
            </th>
          {% endif %}
        {% endmacro %}

        {{ sortable_th('year', 'Year') }}
        <th>Unit</th>
        {{ sortable_th('total_expenditure', 'Total Expenditure') }}
        {{ sortable_th('agriculture_forestry_fishing', 'Agriculture, Forestry, Fishing') }}
        {{ sortable_th('environmental_protection', 'Environmental Protection') }}
        {{ sortable_th('biodiversity_landscape', 'Biodiversity & Landscape') }}
        {{ sortable_th('rd_environmental_protection', 'R&D Environmental Protection') }}
        
        <!-- ACTIONS SÜTUNU - Sadece Admin Görebilir -->
        {% if is_admin %}
        <th>Actions</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for row in records %}
      <tr>
        <td><strong>{{ row['year'] }}</strong></td>
        <td>{{ row['unit'] }}</td>

        <td>
          {% if row['total_expenditure'] is not none %}
            {{ "{:,.2f}".format(row['total_expenditure']) }}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['agriculture_forestry_fishing'] is not none %}
            {{ "{:,.2f}".format(row['agriculture_forestry_fishing']) }}
            {% if row['agriculture_pct'] is not none %}
              <span style="color: #666; font-size: 0.85em;">({{ "{:.2f}".format(row['agriculture_pct']) }}%)</span>
            {% endif %}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['environmental_protection'] is not none %}
            {{ "{:,.2f}".format(row['environmental_protection']) }}
            {% if row['environmental_pct'] is not none %}
              <span style="color: #666; font-size: 0.85em;">({{ "{:.2f}".format(row['environmental_pct']) }}%)</span>
            {% endif %}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['biodiversity_landscape'] is not none %}
            {{ "{:,.2f}".format(row['biodiversity_landscape']) }}
            {% if row['biodiversity_pct'] is not none %}
              <span style="color: #666; font-size: 0.85em;">({{ "{:.2f}".format(row['biodiversity_pct']) }}%)</span>
            {% endif %}
          {% else %}N/A{% endif %}
        </td>

        <td>
          {% if row['rd_environmental_protection'] is not none %}
            {{ "{:,.2f}".format(row['rd_environmental_protection']) }}
            {% if row['rd_pct'] is not none %}
              <span style="color: #666; font-size: 0.85em;">({{ "{:.2f}".format(row['rd_pct']) }}%)</span>
            {% endif %}
          {% else %}N/A{% endif %}
        </td>

        <!-- UPDATE VE DELETE BUTONLARI - Sadece Admin Görebilir -->
        {% if is_admin %}
        <td>
          <a href="{{ url_for('investments.edit_investment_form',
                      country_id=selected_country_id,
                      year=row['year']) }}"
                    class="btn-update">
                    Update
          </a>

          <form method="post"
                action="{{ url_for('investments.delete_investment') }}"
                style="display: inline;"
                onsubmit="return confirm('Delete all records for this year?');">
            <input type="hidden" name="country_id" value="{{ selected_country_id }}">
            <input type="hidden" name="year" value="{{ row['year'] }}">
            <input type="hidden" name="redirect_country_id" value="{{ selected_country_id }}">
            <button type="submit" class="btn-delete">Delete</button>
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% elif country_name and not records %}
  <div class="no-data">
    <p>No investment records found for {{ country_name }}.</p>
  </div>
  {% endif %}
</section>


{% if country_name and records %}
<script>
    const chartData = {{ chart_data | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/investments_timeline.js') }}"></script>
{% endif %}

{% endblock %}